{% extends 'base.html' %}
{% block title %}Make Reservation{% endblock %}
{% block content %}
<div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-md">
  <h2 class="text-2xl font-bold mb-4">Reserve Space: {{ space.name }}</h2>
  <label for="reservationDate" class="block text-gray-700">Select Date:</label>
  <input type="date" id="reservationDate" class="block w-full mt-2 mb-4 p-2 border rounded">
  
  <div id="timeSlots" class="mb-4"></div>
  
  <form method="post" id="reservationForm">
    {% csrf_token %}
    <div id="selectedTimes" class="mb-4 text-gray-700">
      <p>Start Time: <span id="displayStartTime">Not selected</span></p>
      <p>End Time: <span id="displayEndTime">Not selected</span></p>
    </div>
    <div id="availabilityMessage" class="text-red-500"></div>
    <div class="flex justify-between">
      <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded mt-4" id="submitBtn" disabled>Reserve</button>
      <button type="button" class="bg-gray-500 text-white py-2 px-4 rounded mt-4" id="resetBtn">Reset</button>
    </div>
    <input type="hidden" id="id_start_time" name="start_time">
    <input type="hidden" id="id_end_time" name="end_time">
  </form>
  
  <a href="{% url 'list_spaces' %}" class="mt-4 block text-blue-500 underline">Back to Spaces</a>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    let startTime = null;
    let endTime = null;

    function resetSelection() {
      startTime = null;
      endTime = null;
      $('#id_start_time').val('');
      $('#id_end_time').val('');
      $('#displayStartTime').text('Not selected');
      $('#displayEndTime').text('Not selected');
      $('#availabilityMessage').text('');
      $('#submitBtn').prop('disabled', true);
      $('.time-slot').removeClass('bg-blue-500').not('.bg-red-500').addClass('bg-green-500').prop('disabled', false);
    }

    $('#reservationDate').change(function() {
      var date = $(this).val();
      if (date) {
        $.ajax({
          url: "{% url 'get_time_slots' space.id %}",
          data: { date: date },
          success: function(data) {
            var timeSlotsDiv = $('#timeSlots');
            timeSlotsDiv.empty();
            resetSelection();

            for (var time in data) {
              var status = data[time];
              var buttonClass = status === 'available' ? 'bg-green-500 hover:bg-green-700' : 'bg-red-500 cursor-not-allowed';
              var disabled = status === 'unavailable' ? 'disabled' : '';
              var button = `<button type="button" class="time-slot ${buttonClass} text-white py-2 px-4 rounded mb-2 mr-2" data-time="${time}" ${disabled}>${time}</button>`;
              timeSlotsDiv.append(button);
            }

            $('.time-slot').click(function() {
              if (!$(this).hasClass('bg-red-500')) {
                var selectedTime = $(this).data('time');
                if (!startTime || endTime) {
                  startTime = selectedTime;
                  endTime = null;
                  $('.time-slot').removeClass('bg-blue-500').not('.bg-red-500').addClass('bg-green-500');
                  $(this).removeClass('bg-green-500').addClass('bg-blue-500');
                  $('#id_start_time').val(`${date}T${startTime}`);
                  $('#id_end_time').val('');
                  $('#displayStartTime').text(startTime);
                  $('#displayEndTime').text('Not selected');
                } else {
                  let startHour = parseInt(startTime.split(':')[0]);
                  let selectedHour = parseInt(selectedTime.split(':')[0]);

                  if (selectedHour <= startHour) {
                    $('#availabilityMessage').text('End time must be after start time.');
                    return;
                  }

                  let isAvailable = true;
                  for (let hour = startHour + 1; hour <= selectedHour; hour++) {
                    if ($(`[data-time="${hour}:00"]`).hasClass('bg-red-500')) {
                      isAvailable = false;
                      break;
                    }
                  }

                  if (isAvailable) {
                    for (let hour = startHour + 1; hour <= selectedHour; hour++) {
                      $(`[data-time="${hour}:00"]`).removeClass('bg-green-500').addClass('bg-blue-500');
                    }
                    endTime = selectedTime;
                    $('#id_end_time').val(`${date}T${endTime}`);
                    $('#displayEndTime').text(endTime);
                    $('#availabilityMessage').text('');
                    $('#submitBtn').prop('disabled', false);
                  } else {
                    $('#availabilityMessage').text('Selected range is not available.');
                  }
                }
              }
            });
          },
          error: function() {
            $('#timeSlots').empty();
            $('#availabilityMessage').text('Error fetching time slots.');
          }
        });
      }
    });

    $('#resetBtn').click(function() {
      resetSelection();
    });
  });
</script>
{% endblock %}
